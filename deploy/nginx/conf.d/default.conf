# AWOS Dashboard - Nginx top-level config
# This file provides a minimal http-level helper map for WebSocket support and
# includes per-site configuration files from `conf.d/sites/` so you can host
# multiple domains with one proxy container. Create one site file per domain
# under `deploy/nginx/conf.d/sites/` (see example.com.conf).

# Map $http_upgrade to a Connection header value that supports WebSocket upgrades.
# This must be in the http context (top-level) so it's available to server blocks.
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

# Include per-site server blocks. Create files named like example.com.conf
# in the `sites` directory to add additional domains.
include /etc/nginx/conf.d/sites/*.conf;

# Default HTTP server: respond to ACME challenges and redirect other traffic to HTTPS.
server {
    listen 80;
    server_name _; # catch-all; individual site configs should define exact names

    # ACME challenge location used by certbot (webroot)
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
        try_files $uri =404;
    }

    # Everything else -> HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

# If you want a simple single-site fallback, create a file in conf.d/sites/.
# See `deploy/nginx/conf.d/sites/example.com.conf` for a full example including
# WebSocket proxying tweaks and reasonable timeouts.
